#include <Arduino.h>

#define WIFI_SSID "Kan Toi"
#define WIFI_PASS "1111111z"

#include <GyverDBFile.h>
#include <LittleFS.h>
// –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
// –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –≤ —Ñ–∞–π–ª –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
GyverDBFile db(&LittleFS, "/data.db");

#include <SettingsGyver.h>
// —É–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ–Ω—é, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
SettingsGyver sett("Example", &db);
// –∫–ª—é—á–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
enum kk : size_t {
    txt,
    pass,
    uintw,
    intw,
    int64w,

    color,
    dropdown1,
    dropdown2,
    toggle,
    slider,
    selectw,
    sldmin,
    sldmax,

    lbl1,
    lbl2,

    date,
    timew,
    datime,

    btn1,
    btn2,
};
struct Data {
    int batteryChargePercent = 0;
};
Data data;

bool switchState[10];


sets::Logger logger(150);

sets::Colors dbgColorChange(int value) {
    
    if (value < 30) {
        return sets::Colors::Red;
    } else if (value < 70) {
        return sets::Colors::Yellow;
    } else {
        return sets::Colors::Green;
    }
}

// –±–∏–ª–¥–µ—Ä! –¢—É—Ç —Å—Ç—Ä–æ–∏—Ç—Å—è –Ω–∞—à–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫
void build(sets::Builder& b) {
    // –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å, –±—ã–ª–æ –ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ –≤–∏–¥–∂–µ—Ç—É
    if (b.build.isAction()) {
        Serial.print("Set: 0x");
        Serial.print(b.build.id, HEX);
        Serial.print(" = ");
        Serial.println(b.build.value);

        logger.print("Set: 0x");
        logger.println(b.build.id, HEX);
    }

    // –≥—Ä—É–ø–ø–∞. beginGroup –≤—Å–µ–≥–¥–∞ –≤–µ—Ä–Ω—ë—Ç true –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–¥–∞
    if (b.beginGroup("Group 1")) {
        b.Input(kk::txt, "Text");
        b.Pass(kk::pass, "Password");
        b.Input(kk::uintw, "uint");
        b.Input(kk::intw, "int");
        b.Input(kk::int64w, "int 64");
        b.endGroup();  // –ù–ï –ó–ê–ë–´–í–ê–ï–ú –ó–ê–í–ï–†–®–ò–¢–¨ –ì–†–£–ü–ü–£
    }

    if (b.beginGroup("Regex")) {
        char str[10] = "123";
        b.Input("", AnyPtr(str, 10));
        b.Input("", AnyPtr(str, 10), R"(^\d+$)");
        b.Input("", AnyPtr(str, 10), R"(^\d+$)", "–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã");

        b.endGroup();
    }

    // –ø–∞—Ä–∞ –ª–µ–π–±–ª–æ–≤ –≤–Ω–µ –≥—Ä—É–ø–ø—ã. –¢–∞–∫ —Ç–æ–∂–µ –º–æ–∂–Ω–æ
    //b.Label(kk::lbl1, "Random");
    b.Label(kk::lbl2, "temperaturechip", "", sets::Colors::Red);
    b.LinearGauge(H(batCharge), "Battery", 0, 100, "", data.batteryChargePercent,sets::Colors::Green);
    b.LinearGauge(kk::lbl1, "Battery", 0, 100, "", 50,sets::Colors::Green);

    if (b.beginRow()) {
            b.Select(kk::dropdown1, "Switch1", "Red;White");
            b.LED(H(led1), "Color",1, sets::Colors::Red,sets::Colors::Yellow);
            b.endRow();
    }
    if (b.beginRow()) {
            b.LED(H(led2), "Switch2",1, sets::Colors::Red,sets::Colors::Yellow);
            b.Switch(kk::dropdown2, "");
            b.LED(H(led3), "",0, sets::Colors::Red,sets::Colors::Yellow);
            b.endRow();
    }

    b.LED(H(led), "LED",1, sets::Colors::Red,sets::Colors::Green);
    b.ButtonHold("Button Hold", sets::Colors::Blue); 


    // image
     b.Image(H(img), "", "/logo.png");
    // b.Image("", "https://sinoptik.ua/resources/icons/n400-dea6.webp");

    // –µ—â—ë –≥—Ä—É–ø–ø–∞
    // –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–∫–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å: sets::Group(Builder&, title) –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –±–ª–æ–∫ –∫–æ–¥–∞ –≤ —Å–∞–º–æ–º –Ω–∞—á–∞–ª–µ,
    // –≤—ã–∑—ã–≤–∞—Ç—å endGroup –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω–µ –Ω—É–∂–Ω–æ
    // —Ç–∞–∫ –∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (Menu, Buttons)
    {
        sets::Group g(b, "Group 2");
        b.Color(kk::color, "Color");
        b.Switch(kk::toggle, "Switch");
        b.Select(kk::selectw, "Select", "var1;var2;hello");
        b.Slider(kk::slider, "Slider", -10, 10, 0.5, "deg");
        b.Slider2(kk::sldmin, kk::sldmax, "Slider", -10, 10, 0.5, "deg");

        // –ª–æ–≥–≥–µ—Ä, –≤ –Ω–µ–≥–æ –ø–µ—á–∞—Ç–∞–µ–º –≤—ã—à–µ
        b.Log(logger);

        if (b.beginRow()) {
            if (b.Button("click")) {
                Serial.print("click: ");
                Serial.println(b.build.pressed());
            }
            if (b.ButtonHold("hold")) {
                Serial.print("hold: ");
                Serial.println(b.build.pressed());
            }
            b.endRow();
        }
    }

    // —Ä–∞–∑–Ω—ã–µ —Å—Ç–∏–ª–∏ Row –í–ù–ï –ì–†–£–ü–ü–´
    if (b.beginRow("", sets::DivType::Default)) {
        b.Switch("Switch");
        b.Switch("Switch");
        b.endRow();
    }
    if (b.beginRow("", sets::DivType::Block)) {
        b.Switch("Switch");
        b.Switch("Switch");
        b.endRow();
    }
    if (b.beginRow("", sets::DivType::Line)) {
        b.Switch("Switch");
        b.Switch("Switch");
        b.endRow();
    }

    // –∏ –µ—â—ë –≥—Ä—É–ø–ø–∞
    if (b.beginGroup("Group3")) {
        b.Date(kk::date, "Date");
        b.Time(kk::timew, "Time");
        b.DateTime(kk::datime, "Datime");

        // –∞ —ç—Ç–æ –∫–Ω–æ–ø–∫–∞ –Ω–∞ –≤–ª–æ–∂–µ–Ω–Ω–æ–µ –º–µ–Ω—é. –î–∞–ª–µ–µ –Ω—É–∂–Ω–æ –æ–ø–∏—Å–∞—Ç—å –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        if (b.beginMenu("Submenu")) {
            // —Ç—É—Ç —Ç–æ–∂–µ –º–æ–≥—É—Ç –±—ã—Ç—å –≥—Ä—É–ø–ø—ã
            if (b.beginGroup("Group 3")) {
                b.endGroup();
            }

            // –∏ –ø—Ä–æ—Å—Ç–æ –≤–∏–¥–∂–µ—Ç—ã
           

            b.endMenu();  // –Ω–µ –∑–∞–±—ã–≤–∞–µ–º –∑–∞–≤–µ—Ä—à–∏—Ç—å –º–µ–Ω—é
        }

        b.endGroup();
    }

    // –∫–Ω–æ–ø–∫–∏ —è–≤–ª—è—é—Ç—Å—è "–≥—Ä—É–ø–ø–æ–≤—ã–º" –≤–∏–¥–∂–µ—Ç–æ–º, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–Ω–æ–ø–æ–∫ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
    if (b.beginButtons()) {
        // –∫–Ω–æ–ø–∫–∞ –≤–µ—Ä–Ω—ë—Ç true –ø—Ä–∏ –∫–ª–∏–∫–µ
        if (b.Button(kk::btn1, "reload")) {
            Serial.println("reload");
            b.reload();
        }

        if (b.Button(kk::btn2, "clear db", sets::Colors::Blue)) {
            Serial.println("clear db");
            db.clear();
            db.update();
        }

        b.endButtons();  // –∑–∞–≤–µ—Ä—à–∏—Ç—å –∫–Ω–æ–ø–∫–∏
    }
}

// —ç—Ç–æ –∞–ø–¥–µ–π—Ç–µ—Ä. –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –≤–µ–±–º–æ—Ä–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
void update(sets::Updater& upd) {
    // –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ (—Ö—ç—à—É) –≤–∏–¥–∂–µ—Ç–∞
    int randomValue = random(100);
    upd.update(kk::lbl1, randomValue);
    upd.update(kk::lbl2, temperatureRead()); 
    upd.updateColor(H(led), dbgColorChange(randomValue));
    upd.updateColor(kk::lbl1, dbgColorChange(randomValue));
    upd.update(H(led1), db[kk::dropdown1].toInt());
    


    // –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ø—Ä–∏ —Ä—É—á–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ –Ω—É–∂–Ω–æ!
    // –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Å–∞–º–∞
}



void setup() {
    Serial.begin(115200);
    Serial.println();

    // ======== WIFI ========

    // STA
    WiFi.mode(WIFI_AP_STA);
    // if (strlen(WIFI_SSID)) {
    WiFi.begin(WIFI_SSID, WIFI_PASS);
    uint8_t tries = 20;
    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
        if (!--tries) break;
    }
    Serial.println();
    Serial.print("Connected: ");
    Serial.println(WiFi.localIP());
    // }

    // AP
    WiFi.softAP("üåªEXAMPLE_"+ String(random((100))));
    Serial.print("AP: ");
    Serial.println(WiFi.softAPIP());

    // ======== SETTINGS ========
    sett.begin(true, "soniah");
    sett.onBuild(build);
    sett.onUpdate(update);

    sett.onFocusChange([]() {
        Serial.print("Focus: ");
        Serial.println(sett.focused());
    });

    // –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±–º–æ—Ä–¥—ã
    // sett.config.requestTout = 3000;
    // sett.config.sliderTout = 500;
    // sett.config.updateTout = 1000;
    // sett.config.theme = sets::Colors::Green;

    // ======== DATABASE ========
#ifdef ESP32
    LittleFS.begin(true);
#else
    LittleFS.begin();
#endif

    db.begin();

    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞—á–∞–ª—å–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
    db.init(kk::txt, "text");
    db.init(kk::pass, "some pass");
    db.init(kk::uintw, 64u);
    db.init(kk::intw, -10);
    db.init(kk::int64w, 1234567ll);
    db.init(kk::color, 0xff0000);
    db.init(kk::toggle, (bool)1);
    db.init(kk::slider, -3.5);
    db.init(kk::selectw, (uint8_t)1);
    db.init(kk::date, 1719941932);
    db.init(kk::timew, 60);
    db.init(kk::datime, 1719941932);
    db.init(kk::sldmin, -5);
    db.init(kk::sldmax, 5);

    // db.dump(Serial);

    // —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –¥–ª—è rtc
    setStampZone(3);
}

void loop() {
    // —Ç–∏–∫–µ—Ä, –≤—ã–∑—ã–≤–∞—Ç—å –≤ –ª—É–ø–µ
    sett.tick();
  /* 
    // –≤—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–æ —Å –±—Ä–∞—É–∑–µ—Ä–∞
    if (sett.rtc.newSecond()) {
        Serial.println(sett.rtc.toString());
    }
    */
}
